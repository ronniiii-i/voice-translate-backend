<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Voice Translation Call</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 50px auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .status {
        padding: 10px;
        margin: 10px 0;
        border-radius: 5px;
        font-weight: bold;
      }
      .status.connected    { background: #d4edda; color: #155724; }
      .status.disconnected { background: #f8d7da; color: #721c24; }
      .status.waiting      { background: #fff3cd; color: #856404; }
      .status.error        { background: #f8d7da; color: #721c24; }

      .controls {
        margin: 20px 0;
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }

      button {
        padding: 12px 24px;
        font-size: 16px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s;
      }
      button.primary { background: #007bff; color: white; }
      button.primary:hover { background: #0056b3; }
      button.danger  { background: #dc3545; color: white; }
      button.danger:hover { background: #c82333; }
      button:disabled { background: #ccc; cursor: not-allowed; }

      .caption-box {
        margin: 20px 0;
        padding: 15px;
        background: #f8f9fa;
        border-left: 4px solid #007bff;
        min-height: 60px;
      }
      .caption-label { font-size: 12px; color: #666; margin-bottom: 5px; }
      .caption-text  { font-size: 16px; color: #333; }

      select, input[type=text] {
        padding: 10px;
        font-size: 16px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }

      .recording-indicator {
        display: inline-block;
        width: 12px; height: 12px;
        border-radius: 50%;
        background: #ccc;
      }
      .recording-indicator.active { background: #dc3545; animation: pulse 1s infinite; }

      .peer-status {
        margin: 8px 0;
        font-size: 0.9em;
        color: #555;
      }
      .peer-status .dot {
        display: inline-block;
        width: 8px; height: 8px;
        border-radius: 50%;
        margin-right: 6px;
      }
      .dot.online  { background: #28a745; }
      .dot.offline { background: #999; }

      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50%       { opacity: 0.4; }
      }

      .info {
        margin-top: 20px;
        padding: 15px;
        background: #e7f3ff;
        border-radius: 5px;
        font-size: 14px;
        line-height: 1.6;
      }

      /* ‚îÄ‚îÄ Server URL config (shown at top for easy editing) ‚îÄ‚îÄ */
      .server-config {
        margin-bottom: 16px;
        padding: 10px;
        background: #fffbea;
        border: 1px solid #e0c96e;
        border-radius: 5px;
        font-size: 13px;
      }
      .server-config label { font-weight: bold; }
      .server-config input { width: 360px; }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üåç Voice Translation Call</h1>

      <!-- ‚îÄ‚îÄ Server URL ‚Äî edit this to match your backend ‚îÄ‚îÄ -->
      <div class="server-config">
        <label>Backend URL:</label>
        <input type="text" id="serverUrl" value="ws://localhost:8000" />
        <small style="color:#888"> (e.g. wss://xxxx.ngrok-free.app)</small>
      </div>

      <div class="controls">
        <label>My Language:</label>
        <select id="nativeLanguage">
          <option value="en">English</option>
          <option value="fr">French</option>
          <option value="de">German</option>
          <option value="es">Spanish</option>
        </select>

        <label>Room ID:</label>
        <input type="text" id="roomId" value="room1" style="width:100px" />

        <button id="joinBtn"  class="primary">Join Call</button>
        <button id="leaveBtn" class="danger" disabled>Leave Call</button>

        <span class="recording-indicator" id="recordingIndicator" title="Mic active"></span>
      </div>

      <div id="status" class="status disconnected">Disconnected</div>

      <div class="peer-status" id="peerStatus">
        <span class="dot offline" id="peerDot"></span>
        <span id="peerLabel">Waiting for peer to join‚Ä¶</span>
      </div>

      <div class="caption-box">
        <div class="caption-label">Incoming Translation:</div>
        <div class="caption-text" id="translatedCaption">Waiting for translation‚Ä¶</div>
      </div>

      <div class="caption-box">
        <div class="caption-label">Original (what they said):</div>
        <div class="caption-text" id="originalCaption">‚Äî</div>
      </div>

      <audio id="audioPlayer" style="width:100%; margin:20px 0"></audio>

      <div class="info">
        <strong>‚ÑπÔ∏è How it works:</strong><br/>
        ‚Ä¢ Both users open this page, choose their language, enter the same Room ID, and click "Join Call"<br/>
        ‚Ä¢ Speak naturally ‚Äî the system detects when you stop (‚âà1.2s silence) and translates automatically<br/>
        ‚Ä¢ Translated audio plays to the other person; captions show what was said<br/>
        ‚Ä¢ Room supports exactly 2 people; open a different Room ID for a second conversation
      </div>
    </div>

    <script>
      // ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      let ws           = null;
      let mediaStream  = null;
      let audioContext = null;
      let processor    = null;
      let isStreaming  = false;
      let hasPeer      = false;

      const userId = `user_${Math.random().toString(36).substr(2, 9)}`;

      // ‚îÄ‚îÄ DOM refs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      const joinBtn            = document.getElementById("joinBtn");
      const leaveBtn           = document.getElementById("leaveBtn");
      const statusEl           = document.getElementById("status");
      const translatedCaption  = document.getElementById("translatedCaption");
      const originalCaption    = document.getElementById("originalCaption");
      const audioPlayer        = document.getElementById("audioPlayer");
      const nativeLanguage     = document.getElementById("nativeLanguage");
      const roomIdEl           = document.getElementById("roomId");
      const recordingIndicator = document.getElementById("recordingIndicator");
      const peerDot            = document.getElementById("peerDot");
      const peerLabel          = document.getElementById("peerLabel");
      const serverUrlEl        = document.getElementById("serverUrl");

      // ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function setStatus(text, cls) {
        statusEl.textContent  = text;
        statusEl.className    = `status ${cls}`;
      }

      function setPeerOnline(peerId) {
        hasPeer = true;
        peerDot.className   = "dot online";
        peerLabel.textContent = peerId
          ? `üü¢ Peer connected: ${peerId}`
          : "üü¢ Peer connected";
      }

      function setPeerOffline(peerId) {
        hasPeer = false;
        peerDot.className   = "dot offline";
        peerLabel.textContent = "Waiting for peer to join‚Ä¶";
      }

      // ‚îÄ‚îÄ Join ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      joinBtn.addEventListener("click", async () => {
        const room = roomIdEl.value.trim() || "room1";
        const lang = nativeLanguage.value;
        const base = serverUrlEl.value.trim().replace(/\/$/, "");

        const url = `${base}/ws/call/${room}/${userId}`;
        console.log("Connecting to:", url);

        try {
          ws = new WebSocket(url);

          ws.onopen = async () => {
            // Send handshake config
            ws.send(JSON.stringify({ native_lang: lang }));
            await startMicrophone();

            joinBtn.disabled  = true;
            leaveBtn.disabled = false;
            setStatus(`Connected to room '${room}' as ${userId}`, "connected");
          };

          ws.onmessage = async (event) => {
            if (event.data instanceof Blob) {
              // Translated audio from peer
              const url = URL.createObjectURL(event.data);
              audioPlayer.src = url;
              audioPlayer.play().catch(e => console.warn("Audio play blocked:", e));
            } else {
              const msg = JSON.parse(event.data);
              console.log("[WS msg]", msg);

              switch (msg.type) {
                case "connected":
                  console.log("Server confirmed connection:", msg.user_id);
                  break;
                case "peer_joined":
                  setPeerOnline(msg.peer_id);
                  setStatus(`Connected ‚Äî peer ${msg.peer_id} joined`, "connected");
                  break;
                case "peer_left":
                  setPeerOffline(msg.peer_id);
                  setStatus(`Peer left. Waiting for someone to join room '${room}'‚Ä¶`, "waiting");
                  break;
                case "caption":
                  translatedCaption.textContent = msg.text    || "‚Äî";
                  originalCaption.textContent   = msg.original || "‚Äî";
                  break;
                case "pong":
                  break; // keepalive response
                case "error":
                  console.error("Server error:", msg.message);
                  setStatus(`Error: ${msg.message}`, "error");
                  break;
                default:
                  // Legacy / unknown
                  if (msg.info) setStatus(msg.info, "waiting");
              }
            }
          };

          ws.onerror = (err) => {
            console.error("WebSocket error:", err);
            setStatus("Connection error ‚Äî check Backend URL and server logs", "error");
          };

          ws.onclose = (event) => {
            stopMicrophone();
            joinBtn.disabled  = false;
            leaveBtn.disabled = true;
            setStatus(`Disconnected (code ${event.code})`, "disconnected");
            recordingIndicator.classList.remove("active");
            setPeerOffline();
          };

        } catch (err) {
          console.error("Failed to connect:", err);
          alert("Failed to connect: " + err.message);
        }
      });

      // ‚îÄ‚îÄ Leave ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      leaveBtn.addEventListener("click", () => {
        if (ws) ws.close();
        stopMicrophone();
      });

      // ‚îÄ‚îÄ Microphone ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      async function startMicrophone() {
        try {
          mediaStream = await navigator.mediaDevices.getUserMedia({
            audio: {
              echoCancellation: true,
              noiseSuppression: true,
              sampleRate: 16000,
            },
          });

          // Force 16kHz to match Whisper's expected sample rate
          audioContext = new (window.AudioContext || window.webkitAudioContext)({
            sampleRate: 16000,
          });

          const source = audioContext.createMediaStreamSource(mediaStream);

          // 4096 samples @ 16kHz ‚âà 256ms per chunk ‚Äî good VAD granularity
          processor = audioContext.createScriptProcessor(4096, 1, 1);
          source.connect(processor);
          processor.connect(audioContext.destination);

          processor.onaudioprocess = (e) => {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;

            const floatData = e.inputBuffer.getChannelData(0);
            const pcm16     = new Int16Array(floatData.length);

            // Float32 [-1, 1] ‚Üí Int16 [-32768, 32767]
            for (let i = 0; i < floatData.length; i++) {
              const s  = Math.max(-1, Math.min(1, floatData[i]));
              pcm16[i] = s < 0 ? s * 0x8000 : s * 0x7fff;
            }

            ws.send(pcm16.buffer);
            recordingIndicator.classList.add("active");
          };

          isStreaming = true;
          console.log("üé§ Streaming PCM16 @ 16kHz");

        } catch (err) {
          console.error("Microphone error:", err);
          alert("Could not access microphone: " + err.message);
        }
      }

      function stopMicrophone() {
        if (processor)    { processor.disconnect();  processor    = null; }
        if (audioContext) { audioContext.close();     audioContext = null; }
        if (mediaStream)  { mediaStream.getTracks().forEach(t => t.stop()); mediaStream = null; }
        isStreaming = false;
        recordingIndicator.classList.remove("active");
      }

      // ‚îÄ‚îÄ Keepalive ping every 25s to prevent proxy timeouts ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      setInterval(() => {
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ type: "ping" }));
        }
      }, 25000);

      // ‚îÄ‚îÄ Cleanup on page unload ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      window.addEventListener("beforeunload", () => {
        if (ws) ws.close();
        stopMicrophone();
      });
    </script>
  </body>
</html>